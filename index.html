<!doctype html>
<html lang="en">
<head>
<link rel="icon" href="./kimsze_sharp16.ico?v=20260111a" sizes="any">
<link rel="shortcut icon" href="./kimsze_sharp16.ico?v=20260111a">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Subtraction â€” Place Value Mat (Step-by-step)</title>

  <style>
    :root{
      --bg:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;

      --card:#ffffff;
      --shadow:0 14px 30px rgba(2,6,23,.10);
      --radius:22px;

      /* SVG token sizes (base; auto-fit will scale down) */
      --oneW: 22px;  --oneH: 25px;
      --tenW: 16px;  --tenH: 84px;
      --hunW: 54px;  --hunH: 34px;
      --thouW: 48px; --thouH: 56px;

      /* âœ… shrink thousand blocks to 80% */
      --thouScale: .8;

      /* Disc token sizes */
      --disc: 44px;
      --discFont: 14px;

      /* Animation */
      --moveDur: 1400ms;
      --regroupDur: 1100ms;
      --ease: cubic-bezier(.2,.85,.2,1);

      /* Layout */
      --topbarH: 62px;
      --gap: 14px;
      --maxW: 1320px;

      /* âœ… Algorithm column alignment */
      --colCount: 4;          /* set by JS */
      --algoColW: 54px;       /* fixed column width so digits/results line up */
      --algoGap: 14px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
      overflow: hidden; /* no window scrolling */
      -webkit-text-size-adjust: 100%;
      touch-action: manipulation;
    }

    /* âœ… iOS safe-area padding + allow wrap on small screens */
    .topbar{
      height: var(--topbarH);
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(8px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 14px;
      padding-top: calc(10px + env(safe-area-inset-top));
      padding-left: calc(14px + env(safe-area-inset-left));
      padding-right: calc(14px + env(safe-area-inset-right));
      position: sticky;
      top:0;
      z-index: 20;
    }
    .title{
      display:flex;
      align-items:baseline;
      gap:10px;
      font-weight:1000;
      letter-spacing:.2px;
      min-width: 120px;
    }
    .title .big{ font-size: 18px; }

    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:8px 10px;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      font-weight:1000;
      color: var(--muted);
      white-space:nowrap;
    }
    .pill strong{ color: var(--ink); }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight:1000;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
      transition: transform .08s ease;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background:#0f172a;
      border-color:#0f172a;
      color:#fff;
    }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }

    .wrap{
      height: calc(100vh - var(--topbarH));
      max-width: var(--maxW);
      margin: 0 auto;
      padding: 12px 14px 10px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
      display:grid;
      grid-template-columns: 1.55fr .85fr;
      gap: var(--gap);
      overflow:hidden;
      min-height: 0;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:0;
    }

    .leftCard{
      display:grid;
      grid-template-rows: auto 1fr auto;
      min-height:0;
    }
    .cardHead{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .cardHead .h{
      font-weight:1000;
      letter-spacing:.2px;
    }
    .cardHead .sub{
      margin-top:2px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
    }

    .matWrap{
      padding: 12px 14px 12px;
      min-height:0;
    }
    .mat{
      position: relative;
      height: 100%;
      min-height: 460px;
      border-radius: 22px;
      border: 2px solid rgba(15,23,42,.16);
      overflow:hidden;
      background:#fff;
    }

    .cols{
      position:absolute;
      inset:0;
      display:grid;
      grid-template-columns: repeat(var(--cols, 2), 1fr);
    }
    .col{
      background: linear-gradient(180deg, rgba(241,245,249,.95), rgba(241,245,249,.45));
    }
    .col.tint0{ background: linear-gradient(180deg, rgba(223,247,255,.95), rgba(223,247,255,.42)); }
    .col.tint1{ background: linear-gradient(180deg, rgba(255,241,219,.90), rgba(255,241,219,.40)); }
    .col.tint2{ background: linear-gradient(180deg, rgba(255,228,241,.85), rgba(255,228,241,.35)); }
    .col.tint3{ background: linear-gradient(180deg, rgba(239,231,255,.92), rgba(239,231,255,.42)); }
    .col.tint4{ background: linear-gradient(180deg, rgba(233,255,241,.92), rgba(233,255,241,.42)); }
    .col.tint5{ background: linear-gradient(180deg, rgba(255,246,217,.92), rgba(255,246,217,.42)); }
    .col.tint6{ background: linear-gradient(180deg, rgba(230,240,255,.92), rgba(230,240,255,.42)); }
    .col.tint7{ background: linear-gradient(180deg, rgba(255,232,239,.92), rgba(255,232,239,.42)); }

    body.animating .col{ background: #fff !important; }

    .vSep{
      position:absolute;
      top:0; bottom:0;
      width:2px;
      background: rgba(15,23,42,.10);
      pointer-events:none;
    }

    /* âœ… ONE working row only */
    .zones{
      position:absolute;
      inset:0;
      display:grid;
      grid-template-columns: repeat(var(--cols, 2), 1fr);
      grid-template-rows: 1fr;
      pointer-events:none;
    }
    .zone{
      padding: 10px 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .zoneInner{
      width:100%;
      height:100%;
      display:grid;
      place-items:center;
      min-height:0;
    }

    .fitBox{
      transform-origin:center;
      will-change: transform;
    }

    .pile{ width:100%; height:100%; transform-origin:center; will-change: transform; }

    /* âœ… Tens blocks: 5 on top 4 below */
    .pileGrid{
      display:grid;
      grid-template-columns: repeat(5, max-content);
      grid-auto-rows: max-content;
      justify-content:center;
      align-content:center;
      gap: 10px;
    }

    /* âœ… Ones/Hundreds/Thousands blocks + Discs: 5 left 4 right */
    .pileTwoCol{
      --colGap: 18px;
      --rowGap: 10px;
      --discScale: 1;
      display:grid;
      grid-template-columns: max-content max-content;
      column-gap: var(--colGap);
      align-items:end;
      justify-content:center;
      align-content:center;
      height: 100%;
    }
    .pileTwoCol .colL,
    .pileTwoCol .colR{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-end;
      gap: var(--rowGap);
    }

    /* âœ… Thousand DISCS: 80% size and nearer to each other */
    .pileTwoCol[data-place="th"]{
      --discScale: .8;
      --colGap: 10px;
      --rowGap: 6px;
    }

    .token{
      display:block;
      user-select:none;
      pointer-events:none;
    }
    .svgToken{
      display:block;
      width: var(--oneW);
      height: var(--oneH);
    }
    .svgToken.ten{ width: var(--tenW); height: var(--tenH); }
    .svgToken.hun{ width: var(--hunW); height: var(--hunH); }

    /* âœ… thousand blocks: 80% */
    .svgToken.thou{
      width: calc(var(--thouW) * var(--thouScale));
      height: calc(var(--thouH) * var(--thouScale));
    }
    .svgToken svg{ width:100%; height:100%; display:block; }

    .disc{
      width: calc(var(--disc) * var(--discScale, 1));
      height: calc(var(--disc) * var(--discScale, 1));
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      font-size: calc(var(--discFont) * var(--discScale, 1));
      color: rgba(0,0,0,.82);
      text-shadow: 0 1px 0 rgba(255,255,255,.35);
      background: var(--discFill);
      border: 3px solid var(--discRim);
      box-shadow: 0 12px 18px rgba(0,0,0,.16), inset 0 -6px 10px rgba(0,0,0,.10);
      position:relative;
      white-space:nowrap;
    }
    .disc:before{
      content:"";
      position:absolute;
      inset: 5px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 25%,
        rgba(255,255,255,.55) 0%,
        rgba(255,255,255,.18) 28%,
        rgba(255,255,255,0) 60%);
      pointer-events:none;
    }

    .animLayer{
      position: fixed;
      inset: 0;
      pointer-events:none;
      z-index: 80;
    }
    .confettiLayer{
      position: fixed;
      inset: 0;
      pointer-events:none;
      z-index: 95;
      overflow: hidden;
    }
    .ghost{
      position: fixed;
      left:0; top:0;
      will-change: transform, opacity, filter;
      pointer-events:none;
    }
    .ghost.xout:after{
      content:"âœ•";
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      font-size: 34px;
      font-weight: 1000;
      color: rgba(225,29,72,.95);
      text-shadow: 0 2px 0 rgba(255,255,255,.55);
    }
    .movingHidden{ opacity: 0 !important; }

    .eqBar{
      padding: 12px 14px 14px;
      border-top: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(233,243,242,.65), rgba(233,243,242,.18));
      display:flex;
      flex-direction: column;
      align-items:flex-start;
      justify-content:flex-start;
      gap: 8px;
    }
    .eq{
      font-weight: 1000;
      letter-spacing:.2px;
      font-size: clamp(28px, 3.8vw, 52px);
      display:flex;
      align-items:center;
      gap: 12px;
      white-space:nowrap;
    }
    .ansPill{
      min-width: 70px;
      height: 54px;
      border-radius: 16px;
      border: 3px solid rgba(44,93,0,.35);
      background: rgba(214,255,180,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      font-size: 34px;
      color:#000;
      box-shadow: 0 10px 18px rgba(0,0,0,.12);
    }
    .eqHint{
      font-size:12px;
      color: var(--muted);
      font-weight: 900;
    }
    .ansWords{
      font-size: 14px;
      font-weight: 1000;
      color: #000;
      line-height: 1.25;
      border-left: 5px solid rgba(34,197,94,.55);
      padding-left: 10px;
      display:none;
    }
    .ansWords .muted{
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
      display:block;
      margin-bottom: 2px;
    }

    .rightCol{
      display:grid;
      grid-template-rows: auto 1fr;
      gap: var(--gap);
      min-height:0;
    }

    .panelHead{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panelHead .h{
      font-weight:1000;
      letter-spacing:.2px;
    }
    .panelHead .small{
      font-size:12px;
      color: var(--muted);
      font-weight: 900;
      white-space:nowrap;
    }

    .panelBody{
      display:grid;
      grid-template-rows: 290px auto;
      gap: 18px;
      padding: 12px 14px 14px;
      min-height:0;
    }

    .algoBox{
      border-radius: 18px;
      background:#fff;
      border: 1px solid var(--line);
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
      overflow:hidden;
      display:grid;
      place-items:center;
      padding: 10px 10px;
      height: 290px;
    }
    .algoFit{ transform-origin: center; will-change: transform; }

    .pvLabels{
      display:flex;
      justify-content:flex-end;
      gap: var(--algoGap);
      font-weight:1000;
      letter-spacing:.2px;
      font-size: 14px;
      margin-bottom: 2px;
      padding-right: 6px;
      white-space:nowrap;
    }
    .labTH{ color:#16a34a; }
    .labH { color:#ec4899; }
    .labT { color:#f59e0b; }
    .labO { color:#06b6d4; }

    .stack{
      display:grid;
      grid-template-columns: 44px auto;
      gap: 10px;
      align-items:center;
      justify-items:end;
    }

    /* âœ… rename row (shows regrouped values above A) */
    .renameRow{
      display:grid;
      grid-template-columns: repeat(var(--colCount), var(--algoColW));
      column-gap: var(--algoGap);
      align-items:end;
      justify-content:end;
      font-weight:1000;
      white-space:nowrap;
      font-size: 26px;
      line-height: .9;
      margin-bottom: 2px;
    }
    .renameRow span{
      width: var(--algoColW);
      height: 30px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius: 12px;
    }
    .renameRow .blank{ opacity:0; border:0; background:transparent; }
    .renameRow .renamed{
      background: rgba(250,204,21,.28);
      border: 2px solid rgba(245,158,11,.65);
    }

    .minus{
      font-weight:1000;
      font-size: 30px;
      justify-self:start;
      padding-left: 2px;
    }

    /* âœ… digits â€” GRID aligned */
    .digitsCol{
      display:grid;
      grid-template-columns: repeat(var(--colCount), var(--algoColW));
      column-gap: var(--algoGap);
      align-items:end;
      justify-content:end;
      font-weight:1000;
      color:#000;
      white-space:nowrap;
      font-size: 52px;
      line-height: .92;
      position: relative;
    }
    .digitsCol span{
      width: var(--algoColW);
      text-align:center;
      display:block;
      position: relative;
    }
    .digitsCol .blank{ opacity:0; }

    /* optional cross-out on original digits when renamed */
    .digitsCol span.strike:after{
      content:"";
      position:absolute;
      left:8px;
      right:8px;
      top:52%;
      height:4px;
      background: rgba(225,29,72,.75);
      border-radius: 999px;
      transform: rotate(-10deg);
      box-shadow: 0 2px 0 rgba(255,255,255,.55);
      pointer-events:none;
    }

    .barLine{
      height: 6px;
      width: 100%;
      background: #0f172a;
      border-radius: 999px;
      margin-top: 2px;
    }

    /* âœ… results â€” GRID aligned */
    .resultRow{
      display:grid;
      grid-template-columns: repeat(var(--colCount), var(--algoColW));
      column-gap: var(--algoGap);
      align-items:center;
      justify-content:end;
      margin-top: 6px;
    }
    .resBox{
      width: var(--algoColW);
      height: 50px;
      border-radius: 16px;
      border: 3px solid rgba(44,93,0,.35);
      background: rgba(214,255,180,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      font-size: 32px;
      color:#000;
      box-shadow: 0 10px 18px rgba(0,0,0,.12);
    }
    .resBox.mystery{ color: rgba(0,0,0,.35); }

    .lowerPanel{
      border-radius: 18px;
      background:#fff;
      border: 1px solid var(--line);
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
      overflow:hidden;
    }

    .stepCard{
      border: 2px solid rgba(245,158,11,.75);
      border-radius: 18px;
      margin: 12px 12px 10px;
      padding: 12px 12px;
      display:grid;
      gap: 6px;
      background:#fff;
    }
    .stepTitle{
      font-weight:1000;
      font-size: 34px;
      letter-spacing:.2px;
      color: #f59e0b;
      text-decoration: underline;
      text-underline-offset: 6px;
    }
    .stepText{
      font-weight:1000;
      font-size: 20px;
      color:#000;
    }
    .stepEq{
      font-weight:1000;
      font-size: 22px;
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .miniBox{
      width: 54px;
      height: 44px;
      border-radius: 14px;
      border: 3px solid rgba(44,93,0,.35);
      background: rgba(214,255,180,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      font-size: 26px;
      color:#000;
      box-shadow: 0 10px 18px rgba(0,0,0,.12);
    }
    .miniBox.mystery{ color: rgba(0,0,0,.35); }

    .teacherWrap{
      padding: 10px 12px 12px;
      display:grid;
      gap: 10px;
    }
    .fields{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    label{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      display:block;
      margin-bottom: 6px;
    }
    input[type="number"], select{
      width:100%;
      padding: 10px 10px;
      border: 1px solid var(--line);
      border-radius: 14px;
      font-size: 16px; /* âœ… iOS: avoid zoom */
      font-weight: 900;
      outline:none;
      background:#fff;
    }
    .rowBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top: 2px;
    }
    .seg{
      display:flex;
      border:1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
    }
    .seg button{
      border:0;
      background:transparent;
      padding: 10px 12px;
      font-weight:1000;
      font-size:13px;
      color: var(--muted);
      cursor:pointer;
      white-space:nowrap;
    }
    .seg button.active{
      background:#0f172a;
      color:#fff;
    }

    .noteErr{
      font-size:12px;
      font-weight: 900;
      color:#b91c1c;
      background: rgba(239,68,68,.08);
      border: 1px solid rgba(239,68,68,.25);
      padding: 10px 12px;
      border-radius: 14px;
      display:none;
    }

    /* âœ… random row */
    .randRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:end;
    }
    .randRow .btn{ width:100%; }

    /* =========================
       âœ… Child Try-It Panel
       ========================= */
    .childPanel{
      margin: 0 12px 12px;
      border-radius: 18px;
      border: 2px dashed rgba(14,165,233,.55);
      background: linear-gradient(180deg, rgba(224,242,254,.65), rgba(255,255,255,.9));
      padding: 12px 12px;
      display:grid;
      gap: 10px;
    }
    .childTitleRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .childTitle{
      font-weight:1000;
      letter-spacing:.2px;
      color:#0369a1;
      font-size: 16px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .childBadge{
      font-size:12px;
      font-weight:1000;
      color: var(--muted);
      background:#fff;
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      white-space:nowrap;
    }
    .childGrid{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:end;
    }
    .childMsg{
      font-size:12px;
      font-weight: 900;
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid transparent;
      display:none;
      line-height:1.25;
    }
    .childMsg.ok{
      display:block;
      color:#14532d;
      background: rgba(34,197,94,.10);
      border-color: rgba(34,197,94,.25);
    }
    .childMsg.bad{
      display:block;
      color:#7f1d1d;
      background: rgba(239,68,68,.10);
      border-color: rgba(239,68,68,.25);
    }

    @keyframes panelPulse{
      0%{ box-shadow: 0 0 0 rgba(14,165,233,0); }
      35%{ box-shadow: 0 0 0 6px rgba(14,165,233,.18); }
      70%{ box-shadow: 0 0 0 0 rgba(14,165,233,0); }
      100%{ box-shadow: 0 0 0 rgba(14,165,233,0); }
    }
    .pulseTeacher{
      animation: panelPulse 900ms ease-in-out 0s 2;
      border-color: rgba(14,165,233,.55) !important;
    }

    .credit{
      position: fixed;
      right: 14px;
      bottom: 10px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      z-index: 5;
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
      pointer-events:none;
    }

    /* =========================
       âœ… Mobile + Tablet Responsive
       ========================= */

    /* Make topbar auto-height on smaller screens */
    @media (max-width: 980px){
      :root{ --topbarH: auto; }
      body{ overflow:hidden; }

      .topbar{
        height: auto;
        align-items:flex-start;
        flex-wrap:wrap;
        gap:10px;
      }
      .actions{
        width:100%;
        justify-content:flex-start;
      }
      .actions .btn{
        padding: 12px 12px;
        font-size: 14px;
      }

      .wrap{
        height: calc(100vh - 0px);
        grid-template-columns: 1fr;
        padding: 10px 10px 10px;
        gap: 12px;
        overflow:auto;                 /* âœ… allow page scroll on mobile */
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
      }

      .mat{ min-height: 340px; }
      .algoBox{ height: 300px; }
      .panelBody{ grid-template-rows: 300px auto; }
    }

    /* Tight phones */
    @media (max-width: 520px){
      .title .big{ font-size: 16px; }
      .pill{ font-size: 11px; padding: 7px 9px; }

      .eq{
        font-size: clamp(22px, 5.8vw, 34px);
        gap: 8px;
        flex-wrap:wrap;
        white-space:normal;
      }
      .ansPill{ height: 46px; font-size: 28px; border-radius: 14px; }

      .fields{ grid-template-columns: 1fr; }
      .randRow{ grid-template-columns: 1fr; }
      .childGrid{ grid-template-columns: 1fr; }
      .childGrid .btn{ width:100%; }

      .stepTitle{ font-size: 26px; }
      .stepText{ font-size: 16px; }
      .stepEq{ font-size: 16px; }
      .miniBox{ width: 50px; height: 40px; font-size: 22px; }

      /* Algorithm visuals slightly smaller so they fit */
      :root{ --algoColW: 46px; --algoGap: 10px; }
      .digitsCol{ font-size: 44px; }
      .renameRow{ font-size: 22px; }
      .resBox{ height: 44px; font-size: 28px; border-radius: 14px; }

      /* Reduce pile gaps so blocks fit better */
      .pileGrid{ gap: 8px; }
      .pileTwoCol{ --colGap: 12px; --rowGap: 8px; }
    }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{ scroll-behavior: auto !important; }
    }
  </style>
  <script src="https://cdn.counter.dev/script.js" data-id="825e93b6-ce99-40ef-8bcc-125f13297433" data-utcoffset="8"></script>
</head>
<body>
  <div class="topbar">
    <div class="title">
      <span class="big">Subtraction</span>
    </div>

    <div class="actions">
      <div class="pill"><span>A:</span><strong id="pillA">5320</strong></div>
      <div class="pill"><span>B:</span><strong id="pillB">2944</strong></div>
      <div class="pill"><span>Display:</span><strong id="pillMode">Blocks</strong></div>
      <button class="btn" id="btnReset">â†º Reset</button>
      <button class="btn primary" id="btnNext">Next Step â–¶</button>
      <button class="btn" id="btnDone" disabled>Done âœ“</button>
    </div>
  </div>

  <div class="wrap">
    <section class="card leftCard">
      <div class="cardHead">
        <div>
          <div class="h" id="prompt">(a) Subtract 2944 from 5320.</div>
          <div class="sub">Click <b>Next Step</b> to rename (borrow) when needed, then subtract from ones, tens, and so on.</div>
        </div>
      </div>

      <div class="matWrap">
        <div class="mat" id="mat">
          <div class="cols" id="cols"></div>
          <div class="zones" id="zones"></div>
        </div>
      </div>

      <div class="eqBar">
        <div class="eq">
          <span id="eqA">5320</span>
          <span>âˆ’</span>
          <span id="eqB">2944</span>
          <span>=</span>
          <span class="ansPill" id="eqAns">?</span>
        </div>
        <div class="eqHint" id="eqHint">Click Next Step</div>

        <div class="ansWords" id="ansWords">
          <span class="muted">Answer in words (Singapore style)</span>
          <span id="ansWordsText"></span>
        </div>
      </div>
    </section>

    <aside class="card" id="teachCard">
      <div class="panelHead">
        <div class="h">Teaching Panel</div>
        <div class="small">Rename â†’ Subtract</div>
      </div>

      <div class="panelBody">
        <div class="algoBox">
          <div class="algoFit" id="algoFit">
            <div class="pvLabels" id="pvLabels"></div>

            <div class="stack">
              <div></div>
              <div class="renameRow" id="renameRow"></div>

              <div></div>
              <div class="digitsCol" id="rowA"></div>

              <div class="minus">âˆ’</div>
              <div class="digitsCol" id="rowB"></div>

              <div></div>
              <div class="barLine"></div>

              <div></div>
              <div class="resultRow" id="resRow"></div>
            </div>
          </div>
        </div>

        <div class="lowerPanel" id="lowerPanel">
          <div class="stepCard" id="stepCard">
            <div class="stepTitle" id="stepTitle">STEP 1</div>
            <div class="stepText" id="stepText">Rename if needed.</div>
            <div class="stepEq">
              <span id="stepL">?</span>
              <span>=</span>
              <span class="miniBox mystery" id="stepAns">?</span>
            </div>
          </div>

          <!-- âœ… Child Try-It Panel -->
          <div class="childPanel" id="childPanel">
            <div class="childTitleRow">
              <div class="childTitle">ðŸ§’ Child Try-It Panel</div>
              <div class="childBadge">Try: <span id="childEq">5320 âˆ’ 2944</span></div>
            </div>

            <div class="childGrid">
              <div>
                <label>Your answer</label>
                <input id="childAns" type="number" inputmode="numeric" placeholder="Type the difference"/>
              </div>
              <button class="btn primary" id="btnChildCheck">Check âœ…</button>
            </div>

            <div class="childMsg" id="childMsg"></div>
          </div>

          <div class="teacherWrap">
            <div class="fields">
              <div>
                <label>Number A (â‰¤ 4 digits)</label>
                <input id="inA" type="number" min="0" max="9999" step="1" value="5320" inputmode="numeric"/>
              </div>
              <div>
                <label>Number B (â‰¤ 4 digits)</label>
                <input id="inB" type="number" min="0" max="9999" step="1" value="2944" inputmode="numeric"/>
              </div>
            </div>

            <!-- âœ… Random numbers controls -->
            <div class="randRow">
              <div>
                <label>Random: choose digits (A & B)</label>
                <select id="digitsSel">
                  <option value="1">1-digit</option>
                  <option value="2">2-digit</option>
                  <option value="3">3-digit</option>
                  <option value="4" selected>4-digit</option>
                </select>
              </div>
              <button class="btn" id="btnRandom">ðŸŽ² Random Numbers</button>
            </div>

            <div class="rowBtns">
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn primary" id="btnApply">Apply</button>
                <button class="btn" id="btnSwap">Swap A/B</button>
              </div>

              <div class="seg" aria-label="Display mode">
                <button type="button" id="btnBlocks" class="active">Blocks</button>
                <button type="button" id="btnDiscs">Discs</button>
              </div>
            </div>

            <div class="noteErr" id="errBox"></div>
            <div style="font-size:12px; color:var(--muted); font-weight:900;">
              <span id="ruleNote"></span>
            </div>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <div class="credit">Designed by Lim Kim Sze Â© 2026</div>
  <div class="animLayer" id="animLayer"></div>
  <div class="confettiLayer" id="confettiLayer"></div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const MAX_INPUT = 9999;
  const ORDER = ["o","t","h","th"]; // low -> high (ones..thousands)

  const PLACE_META = {
    th: { label:"Thousands", short:"1k",  value: 1000,  labClass:"labTH" },
    h:  { label:"Hundreds",  short:"100", value: 100,   labClass:"labH"  },
    t:  { label:"Tens",      short:"10",  value: 10,    labClass:"labT"  },
    o:  { label:"Ones",      short:"1",   value: 1,     labClass:"labO"  },
  };

  const plural = (placeKey) => {
    const base =
      placeKey==="o" ? "one" :
      placeKey==="t" ? "ten" :
      placeKey==="h" ? "hundred" : "thousand";
    return base + (base==="one" ? "s" : "s");
  };

  // =========================
  // Base-ten SVGs (ALL YELLOW)
  // =========================
  const Y1 = "#f7b12b", Y2 = "#c97e00", Y3 = "#e48f00";

  const SVG_ONE = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 56.5 64">
    <defs><style>
      .cls-1 { fill: ${Y1}; } .cls-2 { fill: ${Y2}; } .cls-3 { fill: ${Y3}; } .cls-4 { fill: #fff; }
    </style></defs>
    <polygon class="cls-2" points="0 16 0 48 28.25 64 28.25 32 0 16"/>
    <polygon class="cls-3" points="28.25 0 0 16 28.25 32 56.5 16 28.25 0"/>
    <polygon class="cls-1" points="56.5 16 28.25 32 28.25 64 56.5 48 56.5 16"/>
    <polygon class="cls-4" points="28.25 33.15 1 17.73 1.5 16.86 28.25 32 55 16.86 55.5 17.73 28.25 33.15"/>
  </svg>`;

  const SVG_TEN = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 39.18 206">
    <defs><style>
      .cls-1 { fill: ${Y1}; } .cls-2 { fill: ${Y2}; } .cls-3 { fill: ${Y3}; } .cls-4 { fill: #fff; }
    </style></defs>
    <polygon class="cls-2" points="0 10.3 0 195.7 19.59 206 19.59 20.6 0 10.3"/>
    <polygon class="cls-3" points="19.59 0 0 10.3 19.59 20.6 39.18 10.3 19.59 0"/>
    <polygon class="cls-1" points="39.18 10.3 19.59 20.6 19.59 206 39.18 195.7 39.18 10.3"/>
    <g>
      <polygon class="cls-4" points="19.59 21.74 1 11.95 1.46 11.06 19.59 20.6 37.72 11.06 38.18 11.95 19.59 21.74"/>
      <polygon class="cls-4" points="19.59 40.24 1 30.45 1.46 29.56 19.59 39.1 37.72 29.56 38.18 30.45 19.59 40.24"/>
      <polygon class="cls-4" points="19.59 58.74 1 48.95 1.46 48.06 19.59 57.6 37.72 48.06 38.18 48.95 19.59 58.74"/>
      <polygon class="cls-4" points="19.59 77.24 1 67.45 1.46 66.56 19.59 76.1 37.72 66.56 38.18 67.45 19.59 77.24"/>
      <polygon class="cls-4" points="19.59 95.74 1 85.95 1.46 85.06 19.59 94.6 37.72 85.06 38.18 85.95 19.59 95.74"/>
      <polygon class="cls-4" points="19.59 114.24 1 104.45 1.46 103.56 19.59 113.1 37.72 103.56 38.18 104.45 19.59 114.24"/>
      <polygon class="cls-4" points="19.59 132.74 1 122.95 1.46 122.06 19.59 131.6 37.72 122.06 38.18 122.95 19.59 132.74"/>
      <polygon class="cls-4" points="19.59 151.24 1 141.45 1.46 140.56 19.59 150.1 37.72 140.56 38.18 141.45 19.59 151.24"/>
      <polygon class="cls-4" points="19.59 169.74 1 159.95 1.46 159.06 19.59 168.6 37.72 159.06 38.18 159.95 19.59 169.74"/>
      <polygon class="cls-4" points="19.59 188.24 1 178.45 1.46 177.56 19.59 187.1 37.72 177.56 38.18 178.45 19.59 188.24"/>
    </g>
  </svg>`;

  const SVG_HUNDRED = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 181.21 118.00">
    <defs>
      <clipPath id="hundred-clip-top"><polygon points="90.60,4.00 177.21,54.00 90.60,104.00 4.00,54.00"/></clipPath>
      <clipPath id="hundred-clip-right"><polygon points="177.21,64.00 90.60,114.00 90.60,104.00 177.21,54.00"/></clipPath>
      <clipPath id="hundred-clip-left"><polygon points="4.00,64.00 90.60,114.00 90.60,104.00 4.00,54.00"/></clipPath>
    </defs>
    <polygon points="4.00,64.00 90.60,114.00 90.60,104.00 4.00,54.00" fill="${Y2}"/>
    <polygon points="177.21,64.00 90.60,114.00 90.60,104.00 177.21,54.00" fill="${Y3}"/>
    <polygon points="90.60,4.00 177.21,54.00 90.60,104.00 4.00,54.00" fill="${Y1}"/>
    <path d="M 4.00 64.00 L 4.00 54.00 M 12.66 69.00 L 12.66 59.00 M 21.32 74.00 L 21.32 64.00 M 29.98 79.00 L 29.98 69.00 M 38.64 84.00 L 38.64 74.00 M 47.30 89.00 L 47.30 79.00 M 55.96 94.00 L 55.96 84.00 M 64.62 99.00 L 64.62 89.00 M 73.28 104.00 L 73.28 94.00 M 81.94 109.00 L 81.94 99.00 M 90.60 114.00 L 90.60 104.00 M 4.00 64.00 L 90.60 114.00 M 4.00 54.00 L 90.60 104.00" clip-path="url(#hundred-clip-left)" fill="none" stroke="#ffffff" stroke-width="1.2" stroke-linecap="round"/>
    <path d="M 177.21 64.00 L 177.21 54.00 M 168.54 69.00 L 168.54 59.00 M 159.88 74.00 L 159.88 64.00 M 151.22 79.00 L 151.22 69.00 M 142.56 84.00 L 142.56 74.00 M 133.90 89.00 L 133.90 79.00 M 125.24 94.00 L 125.24 84.00 M 116.58 99.00 L 116.58 89.00 M 107.92 104.00 L 107.92 94.00 M 99.26 109.00 L 99.26 99.00 M 90.60 114.00 L 90.60 104.00 M 177.21 64.00 L 90.60 114.00 M 177.21 54.00 L 90.60 104.00" clip-path="url(#hundred-clip-right)" fill="none" stroke="#ffffff" stroke-width="1.2" stroke-linecap="round"/>
    <path d="M 90.60 4.00 L 4.00 54.00 M 99.26 9.00 L 12.66 59.00 M 107.92 14.00 L 21.32 64.00 M 116.58 19.00 L 29.98 69.00 M 125.24 24.00 L 38.64 74.00 M 133.90 29.00 L 47.30 79.00 M 142.56 34.00 L 55.96 84.00 M 151.22 39.00 L 64.62 89.00 M 159.88 44.00 L 73.28 94.00 M 168.54 49.00 L 81.94 99.00 M 177.21 54.00 L 90.60 104.00 M 90.60 4.00 L 177.21 54.00 M 81.94 9.00 L 168.54 59.00 M 73.28 14.00 L 159.88 64.00 M 64.62 19.00 L 151.22 69.00 M 55.96 24.00 L 142.56 74.00 M 47.30 29.00 L 133.90 79.00 M 38.64 34.00 L 125.24 84.00 M 29.98 39.00 L 116.58 89.00 M 21.32 44.00 L 107.92 94.00 M 12.66 49.00 L 99.26 99.00 M 4.00 54.00 L 90.60 104.00" clip-path="url(#hundred-clip-top)" fill="none" stroke="#ffffff" stroke-width="1.2" stroke-linecap="round"/>
    <polygon points="4.00,64.00 90.60,114.00 90.60,104.00 4.00,54.00" fill="none" stroke="#ffffff" stroke-width="1.68"/>
    <polygon points="177.21,64.00 90.60,114.00 90.60,104.00 177.21,54.00" fill="none" stroke="#ffffff" stroke-width="1.68"/>
    <polygon points="90.60,4.00 177.21,54.00 90.60,104.00 4.00,54.00" fill="none" stroke="#ffffff" stroke-width="1.68"/>
  </svg>`;

  const SVG_THOUSAND = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 146.56 168.00">
    <defs>
      <clipPath id="thousand-clip-top"><polygon points="73.28,4.00 142.56,44.00 73.28,84.00 4.00,44.00"/></clipPath>
      <clipPath id="thousand-clip-right"><polygon points="142.56,124.00 73.28,164.00 73.28,84.00 142.56,44.00"/></clipPath>
      <clipPath id="thousand-clip-left"><polygon points="4.00,124.00 73.28,164.00 73.28,84.00 4.00,44.00"/></clipPath>
    </defs>
    <polygon points="4.00,124.00 73.28,164.00 73.28,84.00 4.00,44.00" fill="${Y2}"/>
    <polygon points="142.56,124.00 73.28,164.00 73.28,84.00 142.56,44.00" fill="${Y3}"/>
    <polygon points="73.28,4.00 142.56,44.00 73.28,84.00 4.00,44.00" fill="${Y1}"/>
    <path d="M 4.00 124.00 L 4.00 44.00 M 10.93 128.00 L 10.93 48.00 M 17.86 132.00 L 17.86 52.00 M 24.78 136.00 L 24.78 56.00 M 31.71 140.00 L 31.71 60.00 M 38.64 144.00 L 38.64 64.00 M 45.57 148.00 L 45.57 68.00 M 52.50 152.00 L 52.50 72.00 M 59.43 156.00 L 59.43 76.00 M 66.35 160.00 L 66.35 80.00 M 73.28 164.00 L 73.28 84.00 M 4.00 124.00 L 73.28 164.00 M 4.00 116.00 L 73.28 156.00 M 4.00 108.00 L 73.28 148.00 M 4.00 100.00 L 73.28 140.00 M 4.00 92.00 L 73.28 132.00 M 4.00 84.00 L 73.28 124.00 M 4.00 76.00 L 73.28 116.00 M 4.00 68.00 L 73.28 108.00 M 4.00 60.00 L 73.28 100.00 M 4.00 52.00 L 73.28 92.00 M 4.00 44.00 L 73.28 84.00" clip-path="url(#thousand-clip-left)" fill="none" stroke="#ffffff" stroke-width="1.0" stroke-linecap="round"/>
    <path d="M 142.56 124.00 L 142.56 44.00 M 135.64 128.00 L 135.64 48.00 M 128.71 132.00 L 128.71 52.00 M 121.78 136.00 L 121.78 56.00 M 114.85 140.00 L 114.85 60.00 M 107.92 144.00 L 107.92 64.00 M 100.99 148.00 L 100.99 68.00 M 94.07 152.00 L 94.07 72.00 M 87.14 156.00 L 87.14 76.00 M 80.21 160.00 L 80.21 80.00 M 73.28 164.00 L 73.28 84.00 M 142.56 124.00 L 73.28 164.00 M 142.56 116.00 L 73.28 156.00 M 142.56 108.00 L 73.28 148.00 M 142.56 100.00 L 73.28 140.00 M 142.56 92.00 L 73.28 132.00 M 142.56 84.00 L 73.28 124.00 M 142.56 76.00 L 73.28 116.00 M 142.56 68.00 L 73.28 108.00 M 142.56 60.00 L 73.28 100.00 M 142.56 52.00 L 73.28 92.00 M 142.56 44.00 L 73.28 84.00" clip-path="url(#thousand-clip-right)" fill="none" stroke="#ffffff" stroke-width="1.0" stroke-linecap="round"/>
    <path d="M 73.28 4.00 L 4.00 44.00 M 80.21 8.00 L 10.93 48.00 M 87.14 12.00 L 17.86 52.00 M 94.07 16.00 L 24.78 56.00 M 100.99 20.00 L 31.71 60.00 M 107.92 24.00 L 38.64 64.00 M 114.85 28.00 L 45.57 68.00 M 121.78 32.00 L 52.50 72.00 M 128.71 36.00 L 59.43 76.00 M 135.64 40.00 L 66.35 80.00 M 142.56 44.00 L 73.28 84.00 M 73.28 4.00 L 142.56 44.00 M 66.35 8.00 L 135.64 48.00 M 59.43 12.00 L 128.71 52.00 M 52.50 16.00 L 121.78 56.00 M 45.57 20.00 L 114.85 60.00 M 38.64 24.00 L 107.92 64.00 M 31.71 28.00 L 100.99 68.00 M 24.78 32.00 L 94.07 72.00 M 17.86 36.00 L 87.14 76.00 M 10.93 40.00 L 80.21 80.00 M 4.00 44.00 L 73.28 84.00" clip-path="url(#thousand-clip-top)" fill="none" stroke="#ffffff" stroke-width="1.0" stroke-linecap="round"/>
    <polygon points="4.00,124.00 73.28,164.00 73.28,84.00 4.00,44.00" fill="none" stroke="#ffffff" stroke-width="1.4"/>
    <polygon points="142.56,124.00 73.28,164.00 73.28,84.00 142.56,44.00" fill="none" stroke="#ffffff" stroke-width="1.4"/>
    <polygon points="73.28,4.00 142.56,44.00 73.28,84.00 4.00,44.00" fill="none" stroke="#ffffff" stroke-width="1.4"/>
  </svg>`;

  const ui = {
    pillA: $("pillA"), pillB: $("pillB"), pillMode: $("pillMode"),
    eqA: $("eqA"), eqB: $("eqB"), eqAns: $("eqAns"), eqHint: $("eqHint"),
    ansWords: $("ansWords"), ansWordsText: $("ansWordsText"),
    prompt: $("prompt"),
    inA: $("inA"), inB: $("inB"),
    digitsSel: $("digitsSel"), btnRandom: $("btnRandom"),
    btnApply: $("btnApply"), btnSwap: $("btnSwap"),
    btnBlocks: $("btnBlocks"), btnDiscs: $("btnDiscs"),
    btnReset: $("btnReset"), btnNext: $("btnNext"), btnDone: $("btnDone"),
    mat: $("mat"), cols: $("cols"), zones: $("zones"),
    pvLabels: $("pvLabels"),
    renameRow: $("renameRow"),
    rowA: $("rowA"), rowB: $("rowB"), resRow: $("resRow"),
    algoFit: $("algoFit"),
    stepTitle: $("stepTitle"), stepText: $("stepText"), stepL: $("stepL"),
    stepAns: $("stepAns"),
    animLayer: $("animLayer"),
    confettiLayer: $("confettiLayer"),
    ruleNote: $("ruleNote"),
    errBox: $("errBox"),

    // child panel
    childEq: $("childEq"),
    childAns: $("childAns"),
    btnChildCheck: $("btnChildCheck"),
    childMsg: $("childMsg"),

    // teaching highlight targets
    teachCard: $("teachCard"),
    lowerPanel: $("lowerPanel"),
  };

  // =========================
  // Confetti
  // =========================
  function burstConfetti(){
    const layer = ui.confettiLayer;
    if (!layer) return;
    layer.innerHTML = "";

    const W = window.innerWidth || 800;
    const H = window.innerHeight || 600;
    const count = 140;

    for (let i=0;i<count;i++){
      const p = document.createElement("div");
      const size = 6 + Math.random()*8;
      const left = Math.random() * W;
      const top = -20 - Math.random()*H*0.25;

      p.style.position = "absolute";
      p.style.left = left + "px";
      p.style.top = top + "px";
      p.style.width = size + "px";
      p.style.height = (size * (0.7 + Math.random()*0.9)) + "px";
      p.style.borderRadius = (Math.random() < 0.25) ? "999px" : "3px";
      p.style.opacity = "0.95";
      p.style.transform = `rotate(${Math.random()*360}deg)`;
      const hue = Math.floor(Math.random()*360);
      p.style.background = `hsl(${hue} 90% 55%)`;

      layer.appendChild(p);

      const drift = (Math.random()*2 - 1) * W * 0.22;
      const endY = H + 80 + Math.random()*120;
      const rot = (Math.random()*2 - 1) * 980;
      const dur = 1200 + Math.random()*900;
      const delay = Math.random()*120;

      p.animate([
        { transform: `translate(0px, 0px) rotate(0deg)`, opacity: 1 },
        { transform: `translate(${drift}px, ${endY}px) rotate(${rot}deg)`, opacity: 1 }
      ], { duration: dur, delay, easing:"cubic-bezier(.2,.9,.2,1)", fill:"forwards" });

      p.animate([
        { opacity: 1 },
        { opacity: 0 }
      ], { duration: 450, delay: delay + dur - 350, easing:"ease-out", fill:"forwards" });
    }

    setTimeout(() => { layer.innerHTML = ""; }, 2600);
  }

  function pulseTeachingPanel(){
    ui.teachCard.classList.remove("pulseTeacher");
    ui.lowerPanel.classList.remove("pulseTeacher");
    void ui.teachCard.offsetWidth;
    ui.teachCard.classList.add("pulseTeacher");
    ui.lowerPanel.classList.add("pulseTeacher");
    setTimeout(() => {
      ui.teachCard.classList.remove("pulseTeacher");
      ui.lowerPanel.classList.remove("pulseTeacher");
    }, 1800);
  }

  // ======= AUDIO =======
  let audioCtx = null;
  function ensureAudio(){
    if (audioCtx) return audioCtx;
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if (!Ctx) return null;
    audioCtx = new Ctx();
    return audioCtx;
  }
  function resumeAudioIfNeeded(){
    const ctx = ensureAudio();
    if (!ctx) return;
    if (ctx.state === "suspended") ctx.resume().catch(()=>{});
  }
  window.addEventListener("pointerdown", resumeAudioIfNeeded, { passive:true });

  function playClick(){
    const ctx = ensureAudio(); if (!ctx) return;
    const t0 = ctx.currentTime;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "square";
    o.frequency.setValueAtTime(760, t0);
    o.frequency.exponentialRampToValueAtTime(260, t0 + 0.03);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.22, t0 + 0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.07);
    o.connect(g).connect(ctx.destination);
    o.start(t0);
    o.stop(t0 + 0.08);
  }

  function playSwoosh(){
    const ctx = ensureAudio(); if (!ctx) return;
    const t0 = ctx.currentTime;
    const dur = 0.30;
    const bufferSize = Math.floor(ctx.sampleRate * dur);
    const buf = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i=0;i<bufferSize;i++){
      const x = i / bufferSize;
      const env = Math.sin(Math.PI * x);
      data[i] = (Math.random()*2-1) * env * 0.9;
    }
    const src = ctx.createBufferSource(); src.buffer = buf;
    const filter = ctx.createBiquadFilter();
    filter.type = "bandpass";
    filter.frequency.setValueAtTime(900, t0);
    filter.frequency.exponentialRampToValueAtTime(220, t0 + dur);
    const g = ctx.createGain();
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.20, t0 + 0.05);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
    src.connect(filter).connect(g).connect(ctx.destination);
    src.start(t0);
    src.stop(t0 + dur + 0.02);
  }

  function playClap(){
    const ctx = ensureAudio();
    if (!ctx) return;

    if (ctx.state === "suspended"){
      ctx.resume().then(() => playClap()).catch(()=>{});
      return;
    }

    const t0 = ctx.currentTime;

    const comp = ctx.createDynamicsCompressor();
    comp.threshold.setValueAtTime(-20, t0);
    comp.knee.setValueAtTime(18, t0);
    comp.ratio.setValueAtTime(6, t0);
    comp.attack.setValueAtTime(0.003, t0);
    comp.release.setValueAtTime(0.12, t0);
    comp.connect(ctx.destination);

    const mkBurst = (offset, dur, f0, q, gain) => {
      const start = t0 + offset;
      const len = Math.max(0.02, dur);
      const bufferSize = Math.floor(ctx.sampleRate * len);
      const buf = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buf.getChannelData(0);

      for (let i=0;i<bufferSize;i++){
        const x = i / bufferSize;
        const env = Math.pow(1 - x, 2.6);
        data[i] = (Math.random()*2 - 1) * env;
      }

      const src = ctx.createBufferSource();
      src.buffer = buf;

      const bp = ctx.createBiquadFilter();
      bp.type = "bandpass";
      bp.frequency.setValueAtTime(f0, start);
      bp.Q.setValueAtTime(q, start);

      const hp = ctx.createBiquadFilter();
      hp.type = "highpass";
      hp.frequency.setValueAtTime(500, start);

      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, start);
      g.gain.exponentialRampToValueAtTime(gain, start + 0.008);
      g.gain.exponentialRampToValueAtTime(0.0001, start + len);

      src.connect(bp);
      bp.connect(hp);
      hp.connect(g);
      g.connect(comp);

      src.start(start);
      src.stop(start + len + 0.01);
    };

    mkBurst(0.00, 0.13, 1600, 1.1, 0.70);
    mkBurst(0.03, 0.14, 1200, 1.0, 0.55);
    mkBurst(0.07, 0.11, 2200, 1.4, 0.40);
    mkBurst(0.10, 0.10, 900,  0.9, 0.30);
  }

  // ======= HELPERS =======
  const clampInt = (n, min, max) => {
    const raw = (typeof n === "string") ? n : String(n);
    let x = parseInt(raw,10);
    if (!Number.isFinite(x)) x = 0;
    x = Math.floor(x);
    return Math.max(min, Math.min(max, x));
  };
  function cssVar(name){
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || "ease";
  }
  function cssMs(name){
    const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    if (v.endsWith("ms")) return parseFloat(v);
    if (v.endsWith("s")) return parseFloat(v) * 1000;
    const n = parseFloat(v);
    return Number.isFinite(n) ? n : 900;
  }

  function digitLen(n){
    n = Math.abs(n);
    if (n === 0) return 1;
    return String(n).length;
  }

  function splitDigits(n){
    n = clampInt(n, 0, MAX_INPUT);
    const out = { o:0, t:0, h:0, th:0 };
    out.o  = Math.floor(n / 1) % 10;
    out.t  = Math.floor(n / 10) % 10;
    out.h  = Math.floor(n / 100) % 10;
    out.th = Math.floor(n / 1000) % 10;
    return out;
  }

  function getCols(A,B){
    const d = Math.max(digitLen(A), digitLen(B));
    const use = Math.max(1, Math.min(4, d));
    const keys = ["o","t","h","th"].slice(0, use).reverse(); // display: high -> low
    return keys;
  }

  // ======= Disc styling =======
  function shade(hex, amt){
    const m = hex.trim().match(/^#?([0-9a-f]{6})$/i);
    if (!m) return hex;
    const n = parseInt(m[1], 16);
    let r=(n>>16)&255, g=(n>>8)&255, b=n&255;
    const mix = (c)=> Math.max(0, Math.min(255, Math.round(c + (amt>=0?(255-c)*amt:c*amt))));
    r = mix(r); g = mix(g); b = mix(b);
    return "#" + [r,g,b].map(v=>v.toString(16).padStart(2,"0")).join("");
  }
  function discStyle(placeKey){
    const base =
      (placeKey==="o")  ? "#11a7e6" :
      (placeKey==="t")  ? "#f4a11c" :
      (placeKey==="h")  ? "#ff5aa1" :
      "#16a34a";
    const rim  = shade(base, -0.22);
    const top  = shade(base, +0.18);
    const bot  = shade(base, -0.10);
    return { fill: `linear-gradient(180deg, ${top} 0%, ${base} 55%, ${bot} 100%)`, rim };
  }

  // ======= Token factory =======
  let displayMode = "blocks";

  function makeTokenEl(placeKey){
    const el = document.createElement("div");
    el.className = "token";
    el.dataset.place = placeKey;

    if (displayMode === "discs"){
      const st = discStyle(placeKey);
      const d = document.createElement("div");
      d.className = "disc";
      d.style.setProperty("--discFill", st.fill);
      d.style.setProperty("--discRim", st.rim);
      d.textContent = PLACE_META[placeKey].short;
      el.appendChild(d);
      return el;
    }

    const w = document.createElement("div");
    w.className = "svgToken";
    if (placeKey === "o"){
      w.innerHTML = SVG_ONE;
    } else if (placeKey === "t"){
      w.classList.add("ten");
      w.innerHTML = SVG_TEN;
    } else if (placeKey === "h"){
      w.classList.add("hun");
      w.innerHTML = SVG_HUNDRED;
    } else {
      w.classList.add("thou");
      w.innerHTML = SVG_THOUSAND;
    }
    el.appendChild(w);
    return el;
  }

  // ======= Layout rules =======
  function useTwoColForPile(placeKey){
    if (displayMode === "discs") return true;
    if (placeKey === "t") return false;
    return true;
  }

  function ensureTwoColStructure(pileEl){
    if (!pileEl) return;
    if (pileEl.querySelector(".colL")) return;
    const L = document.createElement("div"); L.className = "colL";
    const R = document.createElement("div"); R.className = "colR";
    pileEl.appendChild(L); pileEl.appendChild(R);
  }

  function flattenTokens(pileEl){
    if (!pileEl) return [];
    const L = pileEl.querySelector(".colL");
    const R = pileEl.querySelector(".colR");
    const a = L ? Array.from(L.children) : [];
    const b = R ? Array.from(R.children) : [];
    const extras = Array.from(pileEl.children).filter(
      n => !n.classList?.contains("colL") && !n.classList?.contains("colR")
    );
    return [...a, ...b, ...extras].filter(n => n && n.nodeType === 1 && n.classList.contains("token"));
  }

  function putTokenTwoCol(pileEl, tokenEl){
    ensureTwoColStructure(pileEl);
    const L = pileEl.querySelector(".colL");
    const R = pileEl.querySelector(".colR");
    if (L.children.length < 5) L.appendChild(tokenEl);
    else if (R.children.length < 4) R.appendChild(tokenEl);
    else R.appendChild(tokenEl);
  }

  function repackPile(pileEl, placeKey){
    const tokens = flattenTokens(pileEl);
    const two = useTwoColForPile(placeKey);

    pileEl.innerHTML = "";
    pileEl.dataset.place = placeKey;

    if (two){
      pileEl.className = "pile pileTwoCol";
      ensureTwoColStructure(pileEl);
      for (const t of tokens) putTokenTwoCol(pileEl, t);
    } else {
      pileEl.className = "pile pileGrid";
      for (const t of tokens) pileEl.appendChild(t);
    }
  }

  // ======= Fit helpers =======
  function fitAllPiles(){
    const zones = ui.zones.querySelectorAll(".zone");
    zones.forEach(z => {
      const fit = z.querySelector(".fitBox");
      if (!fit) return;
      fit.style.transform = "scale(1)";
      const availW = z.clientWidth - 10;
      const availH = z.clientHeight - 10;
      const contentW = fit.scrollWidth;
      const contentH = fit.scrollHeight;
      if (contentW < 1 || contentH < 1) return;
      const s = Math.min(1, availW / contentW, availH / contentH);
      fit.style.transform = `scale(${s})`;
    });
  }

  function fitAlgo(){
    ui.algoFit.style.transform = "scale(1)";
    const box = ui.algoFit.parentElement;
    const availW = box.clientWidth - 14;
    const availH = box.clientHeight - 14;
    const w = ui.algoFit.scrollWidth;
    const h = ui.algoFit.scrollHeight;
    if (w < 1 || h < 1) return;
    const s = Math.min(1, availW / w, availH / h);
    ui.algoFit.style.transform = `scale(${s})`;
  }

  // ======= Singapore-style number words (with hyphen) =======
  const ONES = ["zero","one","two","three","four","five","six","seven","eight","nine"];
  const TEENS = ["ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"];
  const TENS = ["","", "twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];

  function twoDigitWords(n){
    n = n % 100;
    if (n < 10) return ONES[n];
    if (n < 20) return TEENS[n-10];
    const t = Math.floor(n/10), o = n%10;
    return o === 0 ? TENS[t] : `${TENS[t]}-${ONES[o]}`;
  }

  function numberToWordsSG(n){
    n = Math.floor(Math.abs(n));
    if (n === 0) return "zero";
    if (n < 100) return twoDigitWords(n);

    const joinHundreds = (x) => {
      const h = Math.floor(x/100);
      const r = x % 100;
      if (h === 0) return twoDigitWords(r);
      if (r === 0) return `${ONES[h]} hundred`;
      return `${ONES[h]} hundred and ${twoDigitWords(r)}`;
    };

    if (n < 1000){
      return joinHundreds(n);
    }

    const thousands = Math.floor(n / 1000);
    const rem = n % 1000;

    const thouWords = `${ONES[thousands]} thousand`;
    if (rem === 0) return thouWords;

    const isExactHundreds = (rem % 100 === 0);
    const connector = (rem < 100 || isExactHundreds) ? " and " : ", ";

    let remWords = "";
    if (rem < 100){
      remWords = twoDigitWords(rem);
    } else {
      remWords = joinHundreds(rem);
    }
    return thouWords + connector + remWords;
  }

  // ======= STATE =======
  let A = 5320, B = 2944;

  const zoneMap = { work:{} };
  let actions = [];
  let actionIndex = 0;
  let busy = false;

  let renameDigits = {};
  let strikeDigits = {};
  let resultDigits = {};

  function showErr(msg){
    ui.errBox.style.display = msg ? "block" : "none";
    ui.errBox.textContent = msg || "";
  }

  function enforceSubRule(){
    if (A < B){
      const tmp = A; A = B; B = tmp;
      ui.inA.value = A;
      ui.inB.value = B;
      showErr("For subtraction, A should be â‰¥ B. Swapped automatically.");
    }
  }

  function setMode(mode){
    displayMode = mode;
    ui.btnBlocks.classList.toggle("active", displayMode==="blocks");
    ui.btnDiscs.classList.toggle("active", displayMode==="discs");
    ui.pillMode.textContent = (displayMode==="blocks") ? "Blocks" : "Discs";
    renderAll();
  }

  function resetChildPanel(){
    ui.childEq.textContent = `${A} âˆ’ ${B}`;
    ui.childAns.value = "";
    ui.childMsg.className = "childMsg";
    ui.childMsg.style.display = "none";
    ui.childMsg.textContent = "";
  }

  function buildActions(cols){
    const work = splitDigits(A);
    const sub  = splitDigits(B);

    const colsSet = new Set(cols);
    const placesAsc = cols.slice().reverse();
    const allAsc = ORDER.filter(k => colsSet.has(k));

    const out = [];
    for (const p of placesAsc){
      while ((work[p] ?? 0) < (sub[p] ?? 0)){
        const pi = allAsc.indexOf(p);
        let donorIndex = -1;
        for (let j = pi+1; j < allAsc.length; j++){
          const k = allAsc[j];
          if ((work[k] ?? 0) > 0){ donorIndex = j; break; }
        }
        if (donorIndex === -1) break;

        for (let j = donorIndex; j > pi; j--){
          const high = allAsc[j];
          const low  = allAsc[j-1];

          const highBefore = work[high];
          const lowBefore  = work[low];

          work[high] = highBefore - 1;
          work[low]  = lowBefore + 10;

          out.push({
            type: "borrow",
            from: high,
            to: low,
            highBefore,
            lowBefore,
            highAfter: work[high],
            lowAfter: work[low],
            text: `Rename ${highBefore} ${plural(high)} ${lowBefore} ${plural(low)} as ${work[high]} ${plural(high)} ${work[low]} ${plural(low)}.`,
          });
        }
      }

      const fromVal = work[p] ?? 0;
      const subVal  = sub[p] ?? 0;
      const resVal  = fromVal - subVal;

      out.push({
        type: "subtract",
        place: p,
        fromVal,
        subVal,
        resVal,
        text: `Subtract from the ${PLACE_META[p].label.toLowerCase()}.`,
        eq: `${fromVal} ${plural(p)} âˆ’ ${subVal} ${plural(p)} = ${resVal} ${plural(p)}`
      });

      work[p] = resVal;
    }
    return out;
  }

  // ======= RENDER =======
  function renderAll(){
    A = clampInt(A, 0, MAX_INPUT);
    B = clampInt(B, 0, MAX_INPUT);

    enforceSubRule();

    ui.pillA.textContent = A;
    ui.pillB.textContent = B;
    ui.eqA.textContent = A;
    ui.eqB.textContent = B;
    ui.prompt.textContent = `(a) Subtract ${B} from ${A}.`;

    ui.ruleNote.textContent = "Use Next Step to follow the renaming (borrowing) steps, then subtract place by place.";
    ui.childEq.textContent = `${A} âˆ’ ${B}`;

    const cols = getCols(A,B);

    ui.cols.style.setProperty("--cols", cols.length);
    ui.zones.style.setProperty("--cols", cols.length);

    ui.cols.innerHTML = "";
    cols.forEach((k, idx) => {
      const d = document.createElement("div");
      d.className = "col tint" + (idx % 8);
      ui.cols.appendChild(d);
    });

    ui.mat.querySelectorAll(".vSep").forEach(el => el.remove());
    for (let i=1;i<cols.length;i++){
      const v = document.createElement("div");
      v.className = "vSep";
      v.style.left = `calc(${(i/cols.length)*100}% - 1px)`;
      ui.mat.appendChild(v);
    }

    ui.zones.innerHTML = "";
    zoneMap.work = {};

    const makeZone = (placeKey) => {
      const z = document.createElement("div");
      z.className = "zone";
      z.dataset.place = placeKey;

      const inner = document.createElement("div");
      inner.className = "zoneInner";

      const fit = document.createElement("div");
      fit.className = "fitBox";

      const pile = document.createElement("div");
      pile.className = "pile";
      pile.dataset.place = placeKey;

      fit.appendChild(pile);
      inner.appendChild(fit);
      z.appendChild(inner);

      zoneMap.work[placeKey] = { zone:z, pile };
      return z;
    };

    cols.forEach(k => ui.zones.appendChild(makeZone(k)));

    const da = splitDigits(A);
    cols.forEach(k => fillPile(zoneMap.work[k].pile, k, da[k] ?? 0));

    renderAlgorithm(cols, A, B);
    resetProcess(cols);

    requestAnimationFrame(() => {
      fitAllPiles();
      fitAlgo();
    });
  }

  function fillPile(pileEl, placeKey, count){
    pileEl.innerHTML = "";
    pileEl.dataset.place = placeKey;
    count = clampInt(count, 0, 99);

    if (useTwoColForPile(placeKey)) {
      pileEl.className = "pile pileTwoCol";
      ensureTwoColStructure(pileEl);
      for (let i=0;i<count;i++){
        const tok = makeTokenEl(placeKey);
        putTokenTwoCol(pileEl, tok);
      }
    } else {
      pileEl.className = "pile pileGrid";
      for (let i=0;i<count;i++){
        const tok = makeTokenEl(placeKey);
        pileEl.appendChild(tok);
      }
    }
  }

  function renderAlgorithm(cols, A, B){
    ui.algoFit.style.setProperty("--colCount", cols.length);

    ui.pvLabels.innerHTML = "";
    cols.forEach(k => {
      const s = document.createElement("span");
      s.className = PLACE_META[k].labClass;
      const name =
        (k==="th") ? "Thousands" :
        (k==="h")  ? "Hundreds" :
        (k==="t")  ? "Tens" :
        "Ones";
      s.textContent = name;
      ui.pvLabels.appendChild(s);
    });

    const buildRow = (n) => {
      const s = String(n);
      const pad = Math.max(0, cols.length - s.length);
      const chars = ("0".repeat(pad) + s).split("");
      return chars.map((ch, i) => ({ ch, blank: i < pad }));
    };

    const ra = buildRow(A);
    const rb = buildRow(B);

    ui.rowA.innerHTML = "";
    ra.forEach(obj => {
      const sp = document.createElement("span");
      sp.textContent = obj.ch;
      if (obj.blank) sp.classList.add("blank");
      ui.rowA.appendChild(sp);
    });

    ui.rowB.innerHTML = "";
    rb.forEach(obj => {
      const sp = document.createElement("span");
      sp.textContent = obj.ch;
      if (obj.blank) sp.classList.add("blank");
      ui.rowB.appendChild(sp);
    });

    ui.renameRow.innerHTML = "";
    cols.forEach(() => {
      const sp = document.createElement("span");
      sp.textContent = "";
      sp.classList.add("blank");
      ui.renameRow.appendChild(sp);
    });

    ui.resRow.innerHTML = "";
    cols.forEach(k => {
      const b = document.createElement("div");
      b.className = "resBox mystery";
      b.id = "res_" + k;
      b.textContent = "?";
      ui.resRow.appendChild(b);
    });

    requestAnimationFrame(fitAlgo);
  }

  function updateRenameDisplay(cols){
    const spans = Array.from(ui.renameRow.children);
    Array.from(ui.rowA.children).forEach(sp => sp.classList.remove("strike"));

    cols.forEach((k, idx) => {
      const sp = spans[idx];
      if (!sp) return;

      const v = (renameDigits[k] ?? null);
      if (v === null || v === undefined){
        sp.textContent = "";
        sp.className = "blank";
      } else {
        sp.textContent = String(v);
        sp.className = "renamed";
        if (strikeDigits[k]){
          const aSp = ui.rowA.children[idx];
          if (aSp) aSp.classList.add("strike");
        }
      }
    });

    const any = cols.some(k => renameDigits[k] !== null && renameDigits[k] !== undefined);
    if (!any){
      spans.forEach(sp => { sp.textContent = ""; sp.className = "blank"; });
    }
  }

  function renderAlgoResults(cols){
    cols.forEach(k => {
      const box = $("res_" + k);
      const v = resultDigits[k];
      if (!box) return;
      if (v === null || v === undefined){
        box.textContent = "?";
        box.classList.add("mystery");
      } else {
        box.textContent = String(v);
        box.classList.remove("mystery");
      }
    });

    const done = cols.every(k => resultDigits[k] !== null);
    if (done){
      const diff = A - B;
      ui.eqAns.textContent = String(diff);
      ui.eqHint.textContent = "Done!";
      ui.btnDone.disabled = false;
      ui.btnNext.disabled = true;

      ui.ansWordsText.textContent = numberToWordsSG(diff);
      ui.ansWords.style.display = "block";
    } else {
      ui.eqAns.textContent = "?";
      ui.ansWords.style.display = "none";
    }
  }

  function updateAlgoHighlight(cols){
    ui.resRow.querySelectorAll(".resBox").forEach(b => {
      b.style.outline = "none";
      b.style.outlineOffset = "0px";
    });

    const next = actions[actionIndex];
    const place = next?.type === "subtract" ? next.place :
                  next?.type === "borrow" ? next.to : null;

    if (place){
      const target = $("res_" + place);
      if (target){
        target.style.outline = "3px dashed rgba(236,72,153,.85)";
        target.style.outlineOffset = "6px";
      }
    }
  }

  function renderStepCard(cols){
    const a = actions[actionIndex];
    if (!a){
      ui.stepTitle.textContent = "DONE";
      ui.stepText.textContent = "All steps completed.";
      ui.stepL.textContent = "Great!";
      ui.stepAns.textContent = "âœ“";
      ui.stepAns.classList.remove("mystery");
      return;
    }

    ui.stepTitle.textContent = `STEP ${actionIndex + 1}`;

    if (a.type === "borrow"){
      ui.stepText.textContent = a.text;
      ui.stepL.textContent = a.text.replace(/^Rename\s+/,"");
      ui.stepAns.textContent = "âœ“";
      ui.stepAns.classList.remove("mystery");
    } else {
      ui.stepText.textContent = a.text;
      ui.stepL.textContent = a.eq;
      ui.stepAns.textContent = "?";
      ui.stepAns.classList.add("mystery");
    }
  }

  function resetProcess(cols){
    actions = buildActions(cols);
    actionIndex = 0;

    renameDigits = {};
    strikeDigits = {};
    resultDigits = {};
    cols.forEach(k => resultDigits[k] = null);

    ui.eqAns.textContent = "?";
    ui.eqHint.textContent = "Click Next Step";
    ui.ansWords.style.display = "none";
    ui.ansWordsText.textContent = "";
    ui.btnDone.disabled = true;
    ui.btnNext.disabled = false;

    updateRenameDisplay(cols);
    updateAlgoHighlight(cols);
    renderStepCard(cols);
    renderAlgoResults(cols);

    resetChildPanel();
  }

  // ======= Smooth helper: animate a â€œsplitâ€ (borrow) =======
  async function borrowSplit(fromPlace, toPlace){
    const fromPile = zoneMap.work[fromPlace].pile;
    const toPile   = zoneMap.work[toPlace].pile;

    const donor = Array.from(fromPile.querySelectorAll(`.token[data-place="${fromPlace}"]`)).slice(-1)[0];
    if (!donor) return;

    document.body.classList.add("animating");
    resumeAudioIfNeeded();
    playSwoosh();

    const fromRect = donor.getBoundingClientRect();
    donor.classList.add("movingHidden");

    const ghostDonor = document.createElement("div");
    ghostDonor.className = "ghost";
    ghostDonor.style.width = fromRect.width + "px";
    ghostDonor.style.height = fromRect.height + "px";
    ghostDonor.style.transform = `translate(${fromRect.left}px, ${fromRect.top}px)`;
    ghostDonor.innerHTML = donor.firstElementChild ? donor.firstElementChild.outerHTML : donor.outerHTML;
    ui.animLayer.appendChild(ghostDonor);

    const c = { x: fromRect.left + fromRect.width/2, y: fromRect.top + fromRect.height/2 };

    await ghostDonor.animate([
      { transform:`translate(${fromRect.left}px, ${fromRect.top}px) scale(1)`, opacity: 1 },
      { transform:`translate(${c.x}px, ${c.y}px) scale(0.55)`, opacity: 1 }
    ], { duration: cssMs("--regroupDur"), easing: cssVar("--ease"), fill:"forwards" }).finished.catch(()=>{});

    playClick();

    await ghostDonor.animate([
      { opacity: 1 },
      { opacity: 0, transform: ghostDonor.style.transform + " scale(0.25)", filter:"blur(0.8px)" }
    ], { duration: 260, easing:"ease-in", fill:"forwards" }).finished.catch(()=>{});

    ghostDonor.remove();
    donor.remove();

    const newTokens = [];
    for (let i=0;i<10;i++){
      const t = makeTokenEl(toPlace);
      t.classList.add("movingHidden");
      toPile.appendChild(t);
      newTokens.push(t);
    }
    repackPile(toPile, toPlace);
    repackPile(fromPile, fromPlace);
    fitAllPiles();

    resumeAudioIfNeeded();
    playSwoosh();

    const endRects = newTokens.map(t => t.getBoundingClientRect());

    const anims = [];
    for (let i=0;i<newTokens.length;i++){
      const er = endRects[i];
      const ghost = document.createElement("div");
      ghost.className = "ghost";
      ghost.style.width = er.width + "px";
      ghost.style.height = er.height + "px";
      ghost.innerHTML = newTokens[i].firstElementChild ? newTokens[i].firstElementChild.outerHTML : newTokens[i].outerHTML;
      ui.animLayer.appendChild(ghost);

      const a = ghost.animate([
        { transform:`translate(${c.x}px, ${c.y}px) scale(0.55)`, opacity: 0.0 },
        { transform:`translate(${c.x}px, ${c.y}px) scale(0.55)`, opacity: 1.0, offset: 0.12 },
        { transform:`translate(${er.left}px, ${er.top}px) scale(1)`, opacity: 1.0 }
      ], { duration: cssMs("--moveDur"), easing: cssVar("--ease"), fill:"forwards" });

      anims.push(a.finished.catch(()=>{}).then(() => ghost.remove()));
    }

    await Promise.all(anims);

    newTokens.forEach(t => t.classList.remove("movingHidden"));
    repackPile(toPile, toPlace);
    fitAllPiles();

    document.body.classList.remove("animating");
  }

  // ======= Smooth helper: subtract tokens (cross-out) =======
  async function crossOutAndRemove(placeKey, count){
    count = clampInt(count, 0, 99);
    if (count <= 0) return;

    const pile = zoneMap.work[placeKey].pile;
    const tokens = Array.from(pile.querySelectorAll(`.token[data-place="${placeKey}"]`)).slice(-count);
    if (!tokens.length) return;

    document.body.classList.add("animating");
    resumeAudioIfNeeded();
    playSwoosh();

    const anims = [];

    for (const t of tokens){
      const r = t.getBoundingClientRect();
      t.classList.add("movingHidden");

      const g = document.createElement("div");
      g.className = "ghost xout";
      g.style.width = r.width + "px";
      g.style.height = r.height + "px";
      g.style.transform = `translate(${r.left}px, ${r.top}px)`;
      g.style.opacity = "1";
      g.innerHTML = t.firstElementChild ? t.firstElementChild.outerHTML : t.outerHTML;
      ui.animLayer.appendChild(g);

      const a = g.animate([
        { transform:`translate(${r.left}px, ${r.top}px) scale(1)`, opacity: 1 },
        { transform:`translate(${r.left}px, ${r.top}px) scale(0.92)`, opacity: 1, offset: 0.65 },
        { transform:`translate(${r.left}px, ${r.top}px) scale(0.82)`, opacity: 0 }
      ], { duration: 520, easing:"ease-in-out", fill:"forwards" });

      anims.push(a.finished.catch(()=>{}).then(() => { g.remove(); t.remove(); }));
    }

    await Promise.all(anims);

    repackPile(pile, placeKey);
    fitAllPiles();

    playClick();
    document.body.classList.remove("animating");
  }

  // ======= STEP LOGIC =======
  async function doNextStep(){
    if (busy) return;

    const cols = getCols(A,B);
    const a = actions[actionIndex];
    if (!a) return;

    busy = true;

    if (a.type === "borrow"){
      renameDigits[a.from] = a.highAfter;
      renameDigits[a.to]   = a.lowAfter;
      strikeDigits[a.from] = true;
      strikeDigits[a.to]   = true;

      updateRenameDisplay(cols);
      renderStepCard(cols);
      updateAlgoHighlight(cols);

      await borrowSplit(a.from, a.to);

      actionIndex += 1;

      updateAlgoHighlight(cols);
      renderStepCard(cols);
      fitAllPiles();
      fitAlgo();
      busy = false;
      return;
    }

    await crossOutAndRemove(a.place, a.subVal);

    resultDigits[a.place] = a.resVal;
    renderAlgoResults(cols);

    ui.stepAns.textContent = String(a.resVal);
    ui.stepAns.classList.remove("mystery");

    actionIndex += 1;

    updateRenameDisplay(cols);
    updateAlgoHighlight(cols);
    renderStepCard(cols);

    fitAllPiles();
    fitAlgo();

    const done = cols.every(k => resultDigits[k] !== null);
    if (done){
      ui.btnDone.disabled = false;
      ui.btnNext.disabled = true;
    }

    busy = false;
  }

  // ======= Child Panel Logic =======
  function setChildMsg(kind, text){
    ui.childMsg.className = "childMsg " + kind;
    ui.childMsg.textContent = text;
    ui.childMsg.style.display = "block";
  }

  function checkChildAnswer(){
    resumeAudioIfNeeded();
    const raw = String(ui.childAns.value ?? "").trim();
    if (!raw){
      setChildMsg("bad", "Type your answer first ðŸ™‚");
      playClick();
      return;
    }
    const guess = parseInt(raw, 10);
    const correct = A - B;

    if (Number.isFinite(guess) && guess === correct){
      setChildMsg("ok", "ðŸŽ‰ Correct! Well done!");
      playClick();
      playClap();
      burstConfetti();
    } else {
      setChildMsg("bad",
        "Not yet. Please follow the Teaching Panel steps (Rename â†’ Subtract), then try again."
      );
      playClick();
      pulseTeachingPanel();
    }
  }

  // ======= Random helpers =======
  function randInt(min, max){
    return Math.floor(min + Math.random() * (max - min + 1));
  }
  function randomByDigits(d){
    d = clampInt(d, 1, 4);
    const min = (d === 1) ? 0 : Math.pow(10, d-1);
    const max = Math.pow(10, d) - 1;
    return randInt(min, max);
  }

  function applyNumbers(a, b){
    A = clampInt(a, 0, MAX_INPUT);
    B = clampInt(b, 0, MAX_INPUT);
    ui.inA.value = A;
    ui.inB.value = B;
    showErr("");
    enforceSubRule();
    renderAll();
  }

  // ======= EVENTS =======
  ui.btnBlocks.addEventListener("click", () => setMode("blocks"));
  ui.btnDiscs.addEventListener("click",  () => setMode("discs"));

  ui.btnRandom.addEventListener("click", () => {
    const d = parseInt(ui.digitsSel.value || "4", 10);
    let a = randomByDigits(d);
    let b = randomByDigits(d);
    if (a < b){ const t=a; a=b; b=t; }
    applyNumbers(a, b);
  });

  ui.btnApply.addEventListener("click", () => {
    showErr("");
    const rawA = ui.inA.value;
    const rawB = ui.inB.value;

    const aIn = clampInt(rawA, 0, MAX_INPUT);
    const bIn = clampInt(rawB, 0, MAX_INPUT);

    const trimmed = (String(rawA).trim() !== "" && parseInt(rawA,10) > MAX_INPUT) ||
                    (String(rawB).trim() !== "" && parseInt(rawB,10) > MAX_INPUT);

    A = aIn;
    B = bIn;
    ui.inA.value = A;
    ui.inB.value = B;

    if (trimmed){
      showErr("Numbers A and B must be 4 digits or less (0â€“9999).");
    }

    enforceSubRule();
    renderAll();
  });

  ui.btnSwap.addEventListener("click", () => {
    showErr("");
    const tmp = A; A = B; B = tmp;
    ui.inA.value = A;
    ui.inB.value = B;
    enforceSubRule();
    renderAll();
  });

  ui.btnReset.addEventListener("click", () => { showErr(""); renderAll(); });
  ui.btnNext.addEventListener("click", () => doNextStep());

  ui.btnChildCheck.addEventListener("click", checkChildAnswer);
  ui.childAns.addEventListener("keydown", (e) => {
    if (e.key === "Enter") checkChildAnswer();
  });

  window.addEventListener("resize", () => {
    requestAnimationFrame(() => {
      fitAllPiles();
      fitAlgo();
    });
  });

  // ======= INIT =======
  ui.pillMode.textContent = "Blocks";
  renderAll();
})();
</script>

</body>
</html>
